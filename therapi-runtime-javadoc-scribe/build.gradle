plugins {
    id 'com.github.johnrengelman.shadow' version '2.0.2'
}

dependencies {
    compileOnly files(System.properties['java.home'] + "/../lib/tools.jar")
    compile 'com.squareup:javapoet:1.10.0'
    shadow project(':therapi-runtime-javadoc')

    testCompile project(':therapi-runtime-javadoc')
    testCompile 'com.google.testing.compile:compile-testing:0.11'
}

shadowJar {
    classifier = null
    mergeServiceFiles()
    // exclude 'META-INF/maven/**'
    relocate 'com.squareup', 'com.github.therapi.runtimejavadoc.repack.com.squareup'
}

tasks.withType(JavaCompile) {
    // disable annotation processing
    options.compilerArgs << "-proc:none"
}

publishing {
    publications {
        mavenJava(MavenPublication) { publication ->
            project.shadow.component(publication)

            pom.withXml {
                asNode().appendNode('description', project.description)

                asNode().children().last() + project.ext.pomConfig

                // Workaround for https://github.com/johnrengelman/shadow/issues/334
                def dep = asNode().get("dependencies")[0].appendNode("dependency")
                dep.appendNode("groupId", project.group)
                dep.appendNode("artifactId", "therapi-runtime-javadoc")
                dep.appendNode("version", project.version)
                dep.appendNode("scope", "compile")
            }

            artifact sourceJar {
                classifier 'sources'
            }

            artifact javadocJar {
                classifier 'javadoc'
            }
        }
    }
}